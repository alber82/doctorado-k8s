import "math"

First = from(bucket: "doctorado")                                                            
  |> range(start: -20m, stop: -1m)
  |> filter(fn: (r) => r["_measurement"] == "prometheus_remote_write")
  |> filter(fn: (r) => r["_field"] == "node_network_receive_bytes_total")
  |> filter(fn: (r) => r["device"] == "eth0")
  |> group(columns: ["instance"], mode:"by")
  |> keep(columns: ["instance", "_value"])
  |> first()

Last = from(bucket: "doctorado")
  |> range(start: -1h, stop: now())
  |> filter(fn: (r) => r["_measurement"] == "prometheus_remote_write")
  |> filter(fn: (r) => r["_field"] == "node_network_receive_bytes_total")
  |> filter(fn: (r) => r["device"] == "eth0")
  |> group(columns: [ "instance"], mode:"by")
  |> keep(columns: ["instance", "_value"])
  |> last()

union(tables: [ First, Last])
|> difference()
|> map(fn: (r) => ({r with _value: math.abs(x: r._value)}))
